{% extends "base.html" %}
{% block content %}
{% include 'components/navbar.html' %}

<div class="details-container">
    <div class="details-header">
        <h2>Project Details #{{ project.id }}</h2>
        <div class="status-badge {{ project.status }}">
            <span>{{ project.status|title }}</span>
        </div>
    </div>

    <div class="details-section">
        <h3><span>Title</span></h3>
        <p>{{ project.title }}</p>

        <h3><span>Description</span></h3>
        <p>{{ project.description }}</p>

        <h3><span>Progress</span></h3>
        <div class="progress-bar">
            <div class="progress" style="width: {{ project.progress }}%">
                <span>{{ project.progress }}%</span>
            </div>
        </div>

        {% if session.is_admin %}
        <div class="action-panel">
            <button class="action-button" onclick="updateProjectStatus('in_progress')">
                <span>Start</span>
            </button>
            <button class="action-button" onclick="updateProjectStatus('review')">
                <span>Review</span>
            </button>
            <button class="action-button" onclick="updateProjectStatus('completed')">
                <span>Complete</span>
            </button>
        </div>
        {% endif %}
    </div>

    <div class="messages-section">
        <h3><span>Messages</span></h3>
        <div class="message-list">
            {% for message in messages %}
            <div class="message-item">
                <p><strong>{{ message.sender_name }}:</strong> {{ message.content }}</p>
                <small>{{ message.created_at }}</small>
            </div>
            {% endfor %}
        </div>

        <div class="message-form">
            <textarea id="messageContent" placeholder="Type your message..."></textarea>
            <button class="action-button" onclick="sendMessage()">
                <span>Send</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

<script>
    async function updateProjectStatus(newStatus) {
        const formData = new FormData();
        formData.append('project_id', '{{ project.id }}');
        formData.append('status', newStatus);

        try {
            const response = await fetch('/update_project', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function sendMessage() {
        const messageContent = document.getElementById('messageContent').value;
        if (messageContent.trim() === "") return; // Prevent sending empty messages

        const formData = new FormData();
        formData.append('project_id', '{{ project.id }}');
        formData.append('content', messageContent);
        formData.append('receiver_id', '{{ 1 if session.username != "admin" else project.user_id }}');

        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                document.getElementById('messageContent').value = ''; // Clear message input
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>