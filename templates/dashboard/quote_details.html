{% extends "base.html" %}
{% block content %}
{% include 'components/navbar.html' %}

<div class="details-container">
    <div class="details-header">
        <h2>Quote Details #{{ quote.id }}</h2>
        <div class="status-badge {{ quote.status }}">
            <span>{{ quote.status|title }}</span>
        </div>
    </div>

    <div class="details-section">
        <h3><span>Title</span></h3>
        <p>{{ quote.title }}</p>

        <h3><span>Description</span></h3>
        <p>{{ quote.description }}</p>

        {% if quote.price %}
        <h3><span>Price</span></h3>
        <p>${{ quote.price }}</p>
        {% endif %}

        {% if session.is_admin %}
        <div class="action-panel">
            <button class="action-button" onclick="updateQuoteStatus('quoted')">
                <span>Quote</span>
            </button>
            <button class="action-button" onclick="updateQuoteStatus('rejected')">
                <span>Reject</span>
            </button>
        </div>
        {% elif quote.status == 'quoted' %}
        <div class="action-panel">
            <button class="action-button" onclick="updateQuoteStatus('accepted')">
                <span>Accept</span>
            </button>
            <button class="action-button" onclick="updateQuoteStatus('rejected')">
                <span>Reject</span>
            </button>
        </div>
        {% endif %}
    </div>

    <div class="messages-section">
        <h3><span>Messages</span></h3>
        <div class="message-list">
            {% for message in messages %}
            <div class="message-item">
                <p><strong>{{ message.sender_name }}:</strong> {{ message.content }}</p>
                <small>{{ message.created_at }}</small>
            </div>
            {% endfor %}
        </div>

        <div class="message-form">
            <textarea id="messageContent" placeholder="Type your message..."></textarea>
            <button class="action-button" onclick="sendMessage()">
                <span>Send</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

<script>
    async function updateQuoteStatus(status) {
        const formData = new FormData();
        formData.append('quote_id', '{{ quote.id }}');
        formData.append('status', status);

        try {
            const response = await fetch('/update_quote', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function sendMessage() {
        const messageContent = document.getElementById('messageContent').value;
        const formData = new FormData();
        formData.append('quote_id', '{{ quote.id }}');
        formData.append('content', messageContent);
        formData.append('receiver_id', '{{ 1 if session.username != "admin" else quote.user_id }}');

        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
                document.getElementById('messageContent').value = ''; // Clear the message input
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>