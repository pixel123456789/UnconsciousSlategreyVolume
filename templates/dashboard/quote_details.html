
{% include 'components/navbar.html' %}
<div class="dashboard-container">
    <div class="quote-details">
        <h2>{{ quote.title }}</h2>
        <p class="description">{{ quote.description }}</p>
        <div class="status-badge {{ quote.status }}">{{ quote.status }}</div>
        {% if quote.price %}
            <p class="price">${{ quote.price }}</p>
        {% endif %}

        {% if session.username == 'admin' and quote.status == 'pending' %}
            <div class="admin-actions">
                <form id="priceForm" onsubmit="submitPrice(event)">
                    <input type="hidden" name="quote_id" value="{{ quote.id }}">
                    <input type="hidden" name="status" value="quoted">
                    <input type="number" name="price" step="0.01" min="0" placeholder="Enter quote price" required>
                    <button type="submit" class="action-button"><span>Send Quote</span></button>
                </form>
            </div>
        {% endif %}

        {% if session.user_id == quote.user_id and quote.status == 'quoted' %}
            <div class="client-actions">
                <button onclick="respondToQuote('accepted')" class="action-button accept"><span>Accept Quote</span></button>
                <button onclick="respondToQuote('rejected')" class="action-button reject"><span>Reject Quote</span></button>
            </div>
        {% endif %}
    </div>

    <div class="messages-section">
        <h3>Messages</h3>
        <div class="messages-container">
            {% for message in messages %}
            <div class="message">
                <p>{{ message.content }}</p>
                <small>{{ message.sender_name }} - {{ message.created_at }}</small>
            </div>
            {% endfor %}
        </div>
        <form id="messageForm" onsubmit="sendMessage(event)">
            <input type="hidden" name="quote_id" value="{{ quote.id }}">
            <input type="hidden" name="receiver_id" value="{% if session.is_admin %}{{ quote.user_id }}{% else %}1{% endif %}">
            <textarea name="content" required placeholder="Type your message..."></textarea>
            <button type="submit" class="action-button"><span>Send Message</span></button>
        </form>
    </div>
</div>

<script>
function submitPrice(event) {
    event.preventDefault();
    const form = event.target;
    const data = new FormData(form);
    
    fetch('/update_quote', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error updating quote');
        }
    });
}

function respondToQuote(status) {
    const data = new FormData();
    data.append('quote_id', '{{ quote.id }}');
    data.append('status', status);
    
    fetch('/update_quote', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/dashboard';
        } else {
            alert(data.error || 'Error updating quote');
        }
    });
}

function sendMessage(event) {
    event.preventDefault();
    const form = event.target;
    const data = new FormData(form);
    
    fetch('/send_message', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error sending message');
        }
    });
}
</script>
